---
title: "Análise preliminar dos dados coletados"
output: html_document
---
Última atualização: **`r Sys.time()`**
```{r, echo=FALSE}
loadd(by_city_monthly)
loadd(by_city_yearly)
loadd(by_state_monthly) 
loadd(by_state_yearly) 
loadd(ibge_data) 
```


```{r, echo=FALSE}
squash_string <- function(string) {
    return(string %>%
               stri_trans_general(id = "Latin-ASCII") %>%
               stri_trans_tolower())
}

make_place_key <- function(city, state) {
  return(paste(city, state, sep = " - "))
  
}
```


### Nomes das cidades com problemas de grafia na tabela *by_cities_monthly*
```{r}
master_table <-
  ibge_data %>%
  mutate(key = squash_string(
    make_place_key(
      Nome_Município,
      Nome_UF
    )
  ))

problem_names_c <- by_city_monthly %>%
    mutate(key = squash_string(make_place_key(Cidade, Estado))) %>%
    mutate(exists = key %in% master_table$key) %>%
    filter(exists == FALSE) 


# Pull unique values
(problem_names_c %>% pull(key) %>% unique)

```

### Nomes das cidades com problemas de grafia na tabela *by_cities_yearly*
```{r}
problem_names_cs <- by_city_yearly %>%
   mutate(key = squash_string(make_place_key(Cidade, Estado))) %>%
   mutate(exists = key %in% master_table$key) %>%
   filter(exists == FALSE) 

# Pull unique values
(problem_names_cs %>% pull(key) %>% unique)
```

### Todos os nomes das cidades com problemas de grafia

```{r}
c(pull(problem_names_c, key), pull(problem_names_cs, key)) %>% unique
```

```{r}
list_df <- list(city_monthly_table = by_city_monthly, 
        cities_yearly_table = by_city_yearly, 
        states_monthly_table = by_state_monthly, 
        states_yearly_table = by_state_yearly)
    summary <- list_df %>%
        map(. %>% 
        group_by(Ano, Estado) %>% 
        summarise(Registros = sum(Registros))
        )
    for (i in seq_along(summary)) {
        summary[[i]]$table <- rep(names(summary[i]), nrow(summary[[i]]))
    }
    summary %>% 
        bind_rows %>% 
        pivot_wider(names_from = table, values_from = Registros)
    
    
```

### Somas dos registros nas tabelas
```{r, echo=FALSE}
# Define a helper function
yearly_aggregate <- function(df) {
  df %>%
    group_by(Ano) %>%
    summarise(Registros = sum(Registros))
}
```

#### Tabela *by_city_monthly*

```{r}
ca <- yearly_aggregate(by_city_monthly)
DT::datatable(ca)
```

#### Tabela *by_city_yearly*
```{r}
csa <- yearly_aggregate(by_city_yearly)
DT::datatable(csa)
```

#### Tabela *by_state_monthly*

```{r}
sa <- yearly_aggregate(by_state_monthly)
DT::datatable(sa)
```

#### Tabela *by_state_monthly*

```{r}
ssa <- yearly_aggregate(by_state_yearly)
DT::datatable(ssa)
```

#### Comparação entre tabelas

```{r}
bind_rows("cities_monthly" = ca, 
          "cities_yearly" = csa, 
          "states_monthly" = sa, 
          "states_yearly" = ssa, 
          .id = "origin_table") %>% 
  pivot_wider(names_from = origin_table, values_from = Registros) %>%
  DT::datatable()
```

#### Tabela *by_city_monthly* vs *by_city_yearly*

```{r}
cma <- by_city_monthly %>%
  group_by(Estado, Ano) %>%
  summarise(Registros = sum(Registros))

cysa <- by_city_yearly %>%
  select(Cidade, Estado, Ano, Registros) %>%
    group_by(Estado, Ano) %>%
  summarise(Registros = sum(Registros))


combined_cities <- 
    bind_rows("cities" = cma, "cities_summary" = cysa, .id = "origin_table") %>%
    pivot_wider(names_from = origin_table, values_from = Registros) %>%
    mutate(delta_abs = abs(cities_summary - cities))


summary(combined_cities)

combined_cities %>% 
  filter(delta_abs != 0) %>%
  arrange(-delta_abs) %>%
  DT::datatable()

ggplot(combined_cities) + geom_histogram(aes(delta_abs), binwidth = 10)
```

#### Tabela *by_state_monthly* vs *by_state_yearly*

```{r}
sma <- by_state_monthly %>%
  group_by(Estado, Ano) %>%
  summarise(Registros = sum(Registros))

sysa <- by_state_yearly %>%
  select(Estado, Ano, Registros)

combined_states <- 
    bind_rows("states" = sma, "states_summary" = sysa, .id = "origin_table") %>%
    pivot_wider(names_from = origin_table, values_from = Registros) %>%
    mutate(delta_abs = abs(states_summary - states))

summary(combined_states)

combined_states %>% 
  filter(delta_abs != 0) %>%
  arrange(-delta_abs) %>%
  DT::datatable()

ggplot(combined_states) + geom_histogram(aes(delta_abs), binwidth = 10)
```


